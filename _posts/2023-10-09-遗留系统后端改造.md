---
layout: post
title: 遗留系统后端改造
categories: [遗留系统, 改造]
description: 
keywords: 遗留系统, 改造
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

系统在经过产品设计，开发实现，完成测试到发布上线，在经历多次迭代和多次人员交替的过程中，很大程度上会出现，代码分层不清楚，组件之间的调用关系成网状结构。每一个组件的变更很难评估影响范围和测试范围，严重影响开发效率、测试效率，同时也直接造成发布后软件的不稳定。 

系统出现上述特点就是典型的遗留系统。此处遗留系统改造特指遗留系统后端改造。

## 遗留系统后端的特点

- 代码质量差
- 架构混乱
- 缺少自动化测试

## 遗留系统后端改造的价值

- 可能成本太高，企业不愿意投入资源去改进；也可能是因为积重难返，根本改不动
- 遗留系统蕴含大量数据资产
- 遗留系统中藏匿着丰富的业务知识

## 系统功能改造

### 改造目标

- 安全的可测试化重构
- 补全测试
- 测试保护下深度重构
- 分层改造

### 改造过程

遗留系统在改造的过程中，基本要经过如下三个阶段：
1. 补全测试
1. 深度重构
1. 分层改造

三个阶段相辅相成，补全测试为深度重构作准备，确保在深度重构后，系统的功能没有受影响，在深度重构完成后，再来进行相应的分层改造，使组件的关系层次分明，减少耦合。

同时改造内容要为业务服务，不做业务不需要的改造内容，改造内容要可度量。比如，对补全测试，可以考虑按如下可度量方式来做：

```
通过对 库存模块 添加单元测试，可提高 库存模块 的内建立质量, 从而降低 库存模块 线上的Bug率
```
通过这样对目标的制定，关注成效，可实现可持续的改进。

```
通过对 XXX系统 进行分层改造，可提高 XXX系统 代码逻辑分层，减少代码组件之间的耦合，
增强代码的扩展性，提高功能新增和变更的开发效率, 从而提高业务快速上线，降低整个功能的
开发时间，节约成本，满足市场快速迭代的需要
```

#### 补全测试

系统要能补全测试，首先代码必须有可测试性，作为遗留系统来说，代码基本都是不可测试的。

把需要补全测试的代码，对于第三方依赖项，如数据库访问，消息队列，缓存等服务进行接口化处理，在通过代码中构造注入，函数注入的方式，来减少依赖，提供测试可 Mock 处理。

代码可测试性的处理，常用有如下方法：

1. 按接口提取方式，通过构造，方法，属性的方式进行注入隔离
1. 在无法使用方法 1 的情况下，可以使用：创建新的方法，在旧方法中进行调用，让新方法做到可测试
1. 在不变更原始方法的前提下，新增方法，再调用原来的方法来实现业务逻辑
1. 针对大量 if else 的场景，以表格的方式整理各分支的条件关系，再进一步进行拆分处理

#### 深度重构

在代码重构前，能写好所有的单元测试，便于在重构后验证业务逻辑是否与重构前一致。

深度重构主要把一业务长方法，重构为业务清晰短方法，可按如下方法处理：  

- 分析代码，识别出代码共包括几个阶段
- 移动代码，将相同阶段的代码放到一起，不同阶段的代码用窄分隔
- 将各个阶段的代码提取成小方法

#### 分层改造

按领域驱动设计的方式，对代码结构进行调整，基本结构如下：

层次名称|依赖|说明
-|-|-
UI|网关|用户交互媒价
网关| Appliction Server |对外提供服务接口
 Appliction Server |Domain,Infrastructure|应用服务，实现应用逻辑
 Domain|仓储层、Infrastructure|系统领域层，实现领域逻辑
仓储层|Infrastructure|实现领域数据存储实现
Infrastructure||基础架构，包括数据存储，缓存，消息队列基础服务的实现


## 新增模块

新增模块，采用上面分层改造的结构进行处理，同时有访问旧有系统功能时，可以采用如下方式进行：

1. 通过旧系统公布API的方式获取数据
1. 原有系统有消息队列的时，可采用数据异步同步
1. 数据库之间采用CDC方式进行数据同步

## 小结

要执行好上述内容，也需要从管理上制定一些策略：

- 制定编码规范
- 设计项目分层结构
- code review 编码规范的执行,建议引入代码分析平台　sonar




